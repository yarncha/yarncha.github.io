---
title: LLVM - 가상화 난독화를 수행하는 pass 제작 (3/)
date: 2020-10-10
Author: yarncha
categories: [LLVM]
tags: [LLVM]
comments: true
---

이번 목표 - **가상화 난독화를 수행하는 pass 작성하기**

-   [ ] switch문을 이용하기 위한 for문 생성
-   [ ] 각 연산들을 모두 case로 구분 (switch문 생성)

* * *

[&lt;&lt; 이전 글에서 이어지는 내용](https://yarncha.github.io/posts/18/)

[깃허브 소스코드 ✨](https://github.com/yarncha/llvm/blob/main/VirtualEditor/VirtualEditor.cpp)

# 1. BasicBlock 나누기

![img](\images\19_01.png)

색깔이 칠해진 부분은, 각 switch case에 들어갈 부분들이다.

우선 switch문을 반복하기 위한 for문을 구현하기 위해 BasicBlock을 for.cond/for.body/for.end/return 이렇게 네 부분으로 나누어준다.

이렇게 나눈 이유는 다음 목록에서 설명할 것이다.

*구분 결과*

![img](\images\19_02.png)

# 2. for문을 위한 조건문을 만들기 및 블럭 간 분기 설정해주기

원래는 for문을 만들어주는 함수가 있으면 그 함수를 통해 for문을 생성하려고 했는데... LLVM 내에서 for문 자체를 만들 수 없는 것 같아 그냥 cond블럭에 branch를 만들고, body가 끝나면 다시 cond로 가서 end로 갈 것인지 다시 body를 반복하게 해 줄것인지 지정해 주면서 for문의 기능을 수행할 수 있도록 할 것이다.

**각 BasicBlock에 대한 설명**
* condBB는 i값을 불러와 비교를 해 본 후 값에 따라 bodyBB 또는 endBB로 분기하도록 한다.
* bodyBB는 이후에 switch로 변환할 부분이다. condBB로 돌아가는 분기와 returnBB로 바로 리턴해버리는 분기 두개가 있는데 이 때문에 오류가 발생하는데 (하나의 BasicBlock안에는 한 분기밖에 들어갈 수 없음) 어차피 switch 하면서 수정해 줄거라 무시한다.
* endBB는 for문이 끝났을 때 동작하는 것을 넣어줘야 한다. 사실 무조건 switch중간에 returnBB로 분기해서 여기로 도달할 일은 없지만 retval에 0을 넣어주고, returnBB로 분기하도록 한다.
* returnBB는 값을 리턴하고 함수를 종료하는 BasicBlock이다.

<!-- ```cpp

```

![img](\images\19_02.png) -->

# 3. switch문 생성

<!-- 이거는 일반적인 케이스로 바꿔줄 때 제일 많이 변경해야 될 부분 같다. 일단은 여기서는 이 코드만 고칠 수 있는 난독화 도구를 만들어 볼 것이므로 그냥 iterator를 내 맘대로 이동시키면서 잘라버린다. -->

# 4. case 추가

<!-- References -->
