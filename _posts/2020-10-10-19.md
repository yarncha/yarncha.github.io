---
title: LLVM - 가상화 난독화를 수행하는 pass 제작 (3/)
date: 2020-10-10
Author: yarncha
categories: [LLVM]
tags: [LLVM]
comments: true
---

이번 목표 - **가상화 난독화를 수행하는 pass 작성하기**

-   [ ] switch문을 이용하기 위한 for문 생성
-   [ ] 각 연산들을 모두 case로 구분 (switch문 생성)

* * *

[&lt;&lt; 이전 글에서 이어지는 내용](https://yarncha.github.io/posts/18/)

[깃허브 소스코드 ✨](https://github.com/yarncha/llvm/blob/main/VirtualEditor/VirtualEditor.cpp)

# 1. BasicBlock 나누기

![img](\images\19_01.png)

색깔이 칠해진 부분은, 각 switch case에 들어갈 부분들이다.

우선 switch문을 반복하기 위한 for문을 구현하기 위해 BasicBlock을 for.cond/for.body/for.end/return 이렇게 네 부분으로 나누어준다.

이렇게 나눈 이유는 다음 목록에서 설명할 것이다.

*구분 결과*

![img](\images\19_02.png)

# 2. for문을 위한 조건문을 만들기 및 블럭 간 분기 설정해주기

LLVM 내에서 for문 자체를 만들 수 없는 것 같아 그냥 cond블럭에 branch를 만들고, body가 끝나면 다시 cond로 가서 end로 갈 것인지 다시 body를 반복하게 해 줄것인지 지정해 주면서 for문의 기능을 수행할 수 있도록 할 것이다.



그 후 for문을 생성한다. for.cond/for.body/for.end로 생성되는데, 바디 부분에는 연산을 집어넣고, end가 끝나면 return과 연결해준다.
이때 basic블럭 안에서는 원래 branch가 하나밖에 없을 수밖에 없어서 for body에 return_bb로 가는 것과 for_end로 가는 것 두개가 있어서 오류를 뱉을 수 있지만 어차피 switch로 바꿔줄거기때문에 냅둔다.

```cpp

```

![img](\images\19_02.png)

# 3. switch문

이거는 일반적인 케이스로 바꿔줄 때 제일 많이 변경해야 될 부분 같다. 일단은 여기서는 이 코드만 고칠 수 있는 난독화 도구를 만들어 볼 것이므로 그냥 iterator를 내 맘대로 이동시키면서 잘라버린다.

<!-- References -->
