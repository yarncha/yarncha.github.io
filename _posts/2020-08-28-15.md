---
layout: post
title: 20.08.28 - [LLVM] Control Flow 난독화
date: 2020-08-28
Author: yarncha
categories:
tags: [LLVM]
comments: true
---

이번 주의 목표

- [] Control Flow 조작하여 난독화해보기

* * *

이번 주에는 LLVM을 이용한 난독화를 해 보기로! 그 중에서도 OLLVM의 [BogusControlFlow]와 같이 "코드의 control flow를 조작하는 난독화"를 시도해 보았다.

우선 난독화에 쓸 간단한 입력 controlTest.c를 만들었다

```c
#include <stdio.h>

int main()
{
  int num=0;
  if(num==0){
    num++;
  }
}
```

여기서 저번에 만든 출력 path를 이용하여 basicblock을 살펴보면

![img](\images\15_01.png)

다음과 같이 Entry/if.then/if.end 로 나뉘는 것을 볼 수 있다.

이러한 코드를 opaque을 이용하여 control flow에 대한 난독화를 해 볼 것이다.

### 1. 난독화하려는 방법

![img](\images\15_02.png)

다음과 같이 항상 참인 결과가 나오는 간단한 Opaque Predicate Block을 만들고, 이 값이 true일때 원래의 basicblock으로 이동하게 한다.

값이 false일때는 원래의 basicblock에서 변형된~(미정:연산자를 변형한/값을 1씩 더해준)~ instructions를 가진 의미 없는 가짜 basicblock을 수행하도록 한다.

\+ 중간중간에 basicblock01->dump()과 같이 dump()를 통해 IR을 볼 수 있다! 이를 이용하면 디버깅처럼 쓸 수 있을 듯 하다.

### 2. 분기문 블럭 생성하여 연결하기

코드를 간단하게 보기 위해 if.then블럭에 대해서만 실행되도록 한정해 두었다.

```cpp
if(BB.getName()=="if.then"){
      BasicBlock *firstBB = &BB;    //BasicBlock 클래스를 사용하기 위해 형변환해줌

      BasicBlock::iterator toSplit = (BasicBlock::iterator)firstBB->getFirstNonPHIOrDbgOrLifetime();
      // toSplit++;
      BasicBlock *newBB = firstBB->splitBasicBlock(toSplit,"newBB");

      firstBB->dump();
      newBB->dump();
      //출력
}
```

toSplit에 (PHINode, debug intrinsic, lifetime intrinsic를 제외한) 첫 번째 instruction을 가져와서, 이 instruction의 위치를 저장해둔다. 여기서 첫 번째 instruction은 아래 사진에서의 " %1 = load i32, i32\* %num, align 4 " 가 된다.

그 후, splitBasicBlock(toSplit, "newBB")을 통해 이 해당 instruction 이후의 instruction들을 newBB라는 이름의 새로운 BasicBlock으로 저장한다.
(이때 toSplit이 가리키는 instruction을 다른 것으로 바꾸고 싶다면, toSplit++을 통해 증가시키며 다음 instruction을 가리킬 수 있다.)

![img](\images\15_03.png)
코드를 실행시켜 결과를 보면, if.then BasicBlock이 다음과 같이 if.then과 newBB 두 부분으로 쪼개지고, 두 블럭들이 무조건 분기를 통해 연결된 것을 볼 수 있다.

\+ getFirstNonPHIOrDbgOrLifetime()함수를 첫 번째 instruction을 가져올때 사용했는데, 왜 이 함수를 사용하는지 궁금하다. 그냥 첫 번째를 가져오면 안 되는건지? PHINode 이런건 뭘까?

### 3. 생성한 블럭의 조건문 변경하기

<!-- References -->

[boguscontrolflow]: https://github.com/obfuscator-llvm/obfuscator "ollvm"
