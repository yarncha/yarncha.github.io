---
layout: post
title: 20.08.28 - [LLVM] Control Flow 조작하기
date: 2020-08-28
Author: yarncha
categories:
tags: [LLVM]
comments: true
---

오늘의 목표

- [] Control Flow 간단하게라도 조작해보기

---------------

## control flow 간단하게라도 조작해보기

OLLVM의 [BogusControlFlow부분]을 참고해서 control flow를 조작해보기로.

간단한 입력 controlTest.c를 만들었다
```c
#include <stdio.h>

int main()
{
  int num=0;
  if(num==0){
    num++;
  }
}
```
여기서 저번에 만든 출력을 이용해서 basicblock을 살펴보면
[img](<\images\15_01.png>)
다음과 같이 Entry/if.then/if.end 로 나뉘는 것을 볼 수 있다.

Opaque Predicates를 이용하여 function에서의 각각의 basicblock에 대해 난독화 작업을 수행할 것이다.

### 1. input설정, 난독화하려는 방법
[img](<\images\15_02.png>)
다음과 같이 항상 참인 결과가 나오는 간단한 Opaque Predicate Block을 만들고, 이 값이 true일때 원래의 basicblock으로 이동하게 한다.
값이 false일때는 원래의 basicblock에서 (미정:연산자를 변형한/값을 1씩 더해준) instructions를 가진 변형된 basicblock을 수행하도록 한다.

+ 중간중간에 basicblock01->dump()과 같이 dump()를 통해 IR을 볼 수 있다! 이를 이용하면 디버깅처럼 쓸 수 있을 듯 하다.

### 2. 한 basicblock에 대해서 난독화 진행해보기


~발전할 수 있는 방안~
+ 저번 시간에 basicblock들의 이름을 출력하는 걸 해봤다. 이때 ㅇ름을 가져오는 것도 가능하니까 무슨 블럭이냐에 따라서 조절가능할수도있을것같음 (if에는 이거, for에는 이거 이런식으로?) 아니면 entry에는 항상 이거 적용하고 조건문에는 뭐~ 이런식
+홀수번째는 무조건 true, 짝수번째는 무조건 false opaque
+변형된 블럭에 연산자 변형 (+ -> -)(* -> / )이런식으로 변형이 가능할것같기도 하고 근데 br관련해서는 아직 아이디어 없음

-----------------------------------------------
<!-- ollvm에서의 bcf는 각 basicblock 앞에 opaque predicate를 이용한 새로운 bb를 넣는데, 이 bb에는 항상 참인 if문이 있어 언제나 기존의 bb로 점프하도록 한다. 다른 분기에는 기존의 bb를 clone하고 랜덤 junk로 채운 bb를 넣는다.-->

<!-- createAlteredBasicBlock
deep clone이 아닌 shallow clone
(가리키는 실체 객체는 복사를 안 하는 복사)
-> http://llvm.1065342.n5.nabble.com/Cloning-block-for-newbie-td46552.html
여기에서는 bb를 복사해서 이거를 변형하는 듯
이게 아니라 CloneBasicBlock 인듯하다


---------------------------------------------

<!-- References -->

[BogusControlFlow부분]: https://github.com/obfuscator-llvm/obfuscator/blob/llvm-4.0/lib/Transforms/Obfuscation/BogusControlFlow.cpp "bcf"
