---
layout: post
title: 20.08.28 - [LLVM] Control Flow 조작하기
date: 2020-08-28
Author: yarncha
categories:
tags: [LLVM]
comments: true
---

이번 주의 목표

- [] Control Flow 간단하게라도 조작해보기

---------------

## control flow 간단하게라도 조작해보기

OLLVM의 [BogusControlFlow]를 참고해서 control flow를 조작해보기로.

간단한 입력 controlTest.c를 만들었다
```c
#include <stdio.h>

int main()
{
  int num=0;
  if(num==0){
    num++;
  }
}
```
여기서 저번에 만든 출력을 이용해서 basicblock을 살펴보면

![img](\images\15_01.png)

다음과 같이 Entry/if.then/if.end 로 나뉘는 것을 볼 수 있다.

Opaque Predicates를 이용하여 function에서의 각각의 basicblock에 대해 난독화 작업을 수행할 것이다.

### 1. 난독화하려는 방법

![img](\images\15_02.png)

다음과 같이 항상 참인 결과가 나오는 간단한 Opaque Predicate Block을 만들고, 이 값이 true일때 원래의 basicblock으로 이동하게 한다.
값이 false일때는 원래의 basicblock에서 (미정:연산자를 변형한/값을 1씩 더해준) instructions를 가진 변형된 basicblock을 수행하도록 한다.

+ 중간중간에 basicblock01->dump()과 같이 dump()를 통해 IR을 볼 수 있다! 이를 이용하면 디버깅처럼 쓸 수 있을 듯 하다.

### 2. 분기문 블럭 생성하여 연결하기

우선 코드를 쉽게 하기 위해 if.then블럭에 대해서만 다뤄 보았다.
```cpp
if(BB.getName()=="if.then"){
      BasicBlock *firstBB = &BB;    //BasicBlock 클래스를 사용하기 위해 형변환해줌

      BasicBlock::iterator toSplit = (BasicBlock::iterator)firstBB->getFirstNonPHIOrDbgOrLifetime();
      // toSplit++;
      BasicBlock *newBB = firstBB->splitBasicBlock(toSplit,"newBB");
      firstBB->dump();
      newBB->dump();
}
```
toSplit에 PHINode, debug intrinsic, lifetime intrinsic를 제외한 첫 번째 instruction을 가져와서, 이 instruction의 위치를 저장해두고 splitBasicBlock을 통해 이 해당 instruction을 포함한 instruction들을 newBB라는 이름의 새로운 BasicBlock으로 저장한다.
이때 toSplit이 가리키는 instruction을 다른 것으로 바꾸고 싶다면, toSplit++을 통해 증가시키며 다음 instruction을 가리킬 수 있다.

![img](\images\15_03.png)
코드를 실행시켜 결과를 보면, if.then BasicBlock이 다음과 같이 if.then과 newBB 두 부분으로 쪼개지고, 두 블럭들이 무조건 분기를 통해 연결된 것을 볼 수 있다.


<!-- References -->

[BogusControlFlow]: https://github.com/obfuscator-llvm/obfuscator/blob/llvm-4.0/lib/Transforms/Obfuscation/BogusControlFlow.cpp "bcf"
